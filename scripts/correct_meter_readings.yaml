# Home Assistant Script: Correct meter readings after late reset
# ==============================================================
#
# This script corrects the meter readings for the missed hours (0-6) on 2026-01-25
# because the reset was executed too late.
#
# Missed values (Tariff 1):
# | Hour | kWh       | Cost (â‚¬)    |
# |------|-----------|-------------|
# | 0    | 0.86900   | 0.2525996   |
# | 1    | 1.34700   | 0.25339     |
# | 2    | 0.94000   | 0.251549    |
# | 3    | 1.25500   | 0.25011     |
# | 4    | 1.06790   | 0.2494899   |
# | 5    | 1.25200   | 0.247523    |
# | 6    | 1.09390   | 0.24849     |
# |------|-----------|-------------|
# | Tot  | 7.82480   | 1.7531486   |
#
# Usage: Add to scripts.yaml or create via Settings > Automations > Scripts
#
# NOTE: The tax_balance (energy tax) is now calculated AUTOMATICALLY based on
# the netting kWh value and the fixed energy tax rate. This is in accordance with
# the statutory netting regulation where energy tax is a fixed rate.

correct_meter_readings:
  alias: "Correct meter readings after late reset"
  description: "Adds the missed values (hours 0-6) to the current meter readings for tariff 1"
  mode: single
  sequence:
    # === Step 1: Correct kWh consumption tariff 1 ===
    - alias: "Correct kWh consumption tariff 1 (+7.8248 kWh)"
      service: dynamic_energy_contract_calculator.set_meter_value
      data:
        entity_id: sensor.dynamic_energy_contract_calculator_sensor_energy_consumption_tarif_1_kwh_total
        value: >-
          {{ (states('sensor.dynamic_energy_contract_calculator_sensor_energy_consumption_tarif_1_kwh_total') | float(0)) + 7.8248 }}

    # === Step 2: Correct cost consumption tariff 1 ===
    - alias: "Correct cost consumption tariff 1 (+1.7531486 EUR)"
      service: dynamic_energy_contract_calculator.set_meter_value
      data:
        entity_id: sensor.dynamic_energy_contract_calculator_sensor_energy_consumption_tarif_1_cost_total
        value: >-
          {{ (states('sensor.dynamic_energy_contract_calculator_sensor_energy_consumption_tarif_1_cost_total') | float(0)) + 1.7531486 }}

    # === Step 3: Correct kWh during cost tariff 1 ===
    # This sensor tracks how many kWh were consumed during periods with positive price
    - alias: "Correct kWh during cost tariff 1 (+7.8248 kWh)"
      service: dynamic_energy_contract_calculator.set_meter_value
      data:
        entity_id: sensor.dynamic_energy_contract_calculator_sensor_energy_consumption_tarif_1_kwh_during_cost_total
        value: >-
          {{ (states('sensor.dynamic_energy_contract_calculator_sensor_energy_consumption_tarif_1_kwh_during_cost_total') | float(0)) + 7.8248 }}

    # === Step 4: Correct netting net_consumption_kwh ===
    # The netting tracker tracks how much net consumption there is (consumption - production)
    # The tax_balance (energy tax) is AUTOMATICALLY calculated as:
    #   tax_balance = max(net_consumption_kwh, 0) * per_unit_government_electricity_tax
    - alias: "Correct netting value (+7.8248 kWh)"
      service: dynamic_energy_contract_calculator.set_netting_value
      data:
        # Previous netting value was 4.24 kWh, new value: 4.24 + 7.8248 = 12.0648
        value: 12.0648

    # === Step 5: Log result ===
    - alias: "Log correction completed"
      service: system_log.write
      data:
        message: >-
          Meter readings corrected: +7.8248 kWh, +7.8248 kWh during cost, +1.7531486 EUR, netting to 12.0648 kWh (tax_balance is calculated automatically)
        level: info
        logger: dynamic_energy_contract_calculator.correction
